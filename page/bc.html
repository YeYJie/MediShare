<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="/ht.js"></script>
		<script type="text/javascript" src="/ht-flow.js"></script>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" crossorigin="anonymous">
	</head>

<script type="text/javascript">

var cw;
function shit() {
	console.log("shit...");
	cw = parent.window.document.getElementById("iframe").contentWindow;
}

</script>

<body>
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-5 pre-scrollable" id="blockchain-div" style="max-height: 100vh;">

			</div>
			<div class="col-md-7" id="flow-div">
				<iframe id="iframe" class="embed-responsive-item" src="/iframe.html" style="width: 100%; height: 100vh;" onload="shit();"></iframe>
			</div>
		</div>
	</div>
</body>

<script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" crossorigin="anonymous"></script>

<script src="/socket.io/socket.io.js"></script>

<script type="text/javascript">

var blocks = {};

var socket = io();
socket.emit('watch', {});

socket.on('event', function(data) {
	console.log("socket.on event, data: ", data);
	$.ajax({
		type: "GET",
		url: "/getLatestBlock",
		contentType: false,
		processData: false,
		success: function(block) {
			console.log("ajax get /getLatestBlock: ", block);
			doSomeStatistic(block);
			showBlock(block);
			showStatistic();
			return false;
		},
		error: function(xhr) {
		}
	});
});

var registerCount = {};
var dataSharing = {};

function doSomeStatistic(block) {
	for(var i = 0; i < block.txCount; i++) {
		var tx = block.txs[i];
		if(tx.EventType === "register") {
			var hid = tx.Payload.Hospital;
			if(registerCount[hid]) {
				registerCount[hid] += 1;
			} else {
				registerCount[hid] = 1;
			}
		}
		if(tx.EventType === "requestGrant") {
			var pid = tx.Payload.Patient;
			var rh = tx.Payload.RequestHospital;
			var th = tx.Payload.TargetHospital;
			if(rh === th) return;
			if(!dataSharing[pid]) {
				dataSharing[pid] = [];
			}
			dataSharing[pid].push(cw.eList[th][rh]);
		}
		if(tx.EventType === "deRegister") {
			var hid = tx.Payload.Hospital;
			registerCount[hid] -= 1;
			var pid = tx.Payload.Patient;
			if(dataSharing[pid]) {
				delete dataSharing[pid];
			}
		}
	}
}

function showStatistic() {
	for(var hid in registerCount) {
		cw.hList[hid].setStyle("note", "patient on register: " + registerCount[hid].toString());
	}
	cw.removeAllFlow();
	for(var pid in dataSharing) {
		var edges = dataSharing[pid];
		for(var i = 0; i < edges.length; i++) {
			cw.addFlowForEdge(edges[i]);
		}
	}
}

var latestBlockNum;

function blockHelper(bn) {
	if(bn >= parseInt(latestBlockNum)) {
		showStatistic();
		return;
	}
	$.ajax({
		type: "GET",
		url: "/gbbn/" + bn.toString(),
		contentType: false,
		processData: false,
		success: function(block) {
			blocks[bn.toString()] = block;
			showBlock(block);
			doSomeStatistic(block);
			blockHelper(bn + 1);
			return false;
		},
		error: function(xhr) {
			blockHelper(bn + 1);
			return false;
		}
	});
}

$.ajax({
	type: "GET",
	url: "/gch",
	contentType: false,
	processData: false,
	success: function(bn) {
		console.log("ajax get /gch: ", bn);
		latestBlockNum = bn;
		blockHelper(1);
		return false;
	},
	error: function(xhr) {
	}
});




function timeToString(t) {
	var date = new Date(parseInt(t) * 1000);
	var year = date.getFullYear().toString();
	var month = (date.getMonth() + 1).toString();
	var day = date.getDate().toString();
	var hour = date.getHours().toString();
	var minute = date.getMinutes().toString();
	var second = date.getSeconds().toString();
	return [year, month, day].join('-') + ' ' + [hour, minute, second].join(':')
}

function showBlock(block) {
	blocks[block.blocknum.toString()] = block;
	var blockHTML = buildBlock(block);
	document.getElementById("blockchain-div").innerHTML += blockHTML;
}

function buildBlock(block) {
	var res = ''
	+'<div class="row"><div style="height: 3vh;"></div></div>'
	+'<div class="row">'
	+'	<div class="col-md-12">'
	+'		<div class="card card-block">'
	+'			<div class="card-header">'
	+'				<a href="javascript:void(0);" '
	+'					id="block-' + block.blocknum.toString() + '" '
	+'					data-bid="' + block.blocknum.toString() + '">Block # ' + block.blocknum.toString() + '</a>'
	+'			</div>'
	+'			<div class="card-block">'
	+'				<table class="table table-bordered" style="margin-bottom: 0;">'
	+'						<tr><td colspan="12">Prev Hash: ' + block.prevhash + '</td></tr>'
	+'						<tr><td colspan="12">Data Hash: ' + block.datahash + '</td></tr>'
	+'						<tr><td colspan="8">Timestamp: ' + block.timestamp + '</td>'
	+'							<td colspan="4">Tx Count: ' + block.txCount + '</td></tr>';


	for(var i = 0; i < block.txCount; i++) {
		res += buildRow(i, block.txs[i]);
	}

	res += ''
	+'				</table>'
	+'			</div>'
	+'		</div>'
	+'	</div>'
	+'</div>';

	return res;
};

var buildRow = function(i, tx) {
	var payloadHTML = ''
		+'<tr><td colspan="1"># ' + i + '</td><td colspan="2">EventType: ' + tx.EventType + '</td>'
		+'		<td colspan="9">Tx Timestamp: ' + tx.Timestamp + '</td></tr>'
		+'<tr><td colspan="12">TxId: ' + tx.TxId + '</td></tr>'

	var payload = tx.Payload;
	if(tx.EventType === "register") {
		payloadHTML += ''
		+'<tr><td rowspan="2">Payload: </td><td colspan="5">Patient: ' + payload.Patient + '</td>'
		+'		<td colspan="5">Doctor: ' + payload.Doctor + '</td></tr>'
		+'<tr><td colspan="5">Hospital: ' + payload.Hospital + '</td>'
		+		'<td colspan="5">Time: ' + timeToString(payload.HospitalTime) + '</td></tr>'
	}
	else if(tx.EventType === "deRegister") {
		payloadHTML += ''
		+'<tr><td rowspan="2">Payload: </td><td colspan="5">Patient: ' + payload.Patient + '</td>'
		+'		<td colspan="5">Doctor: ' + payload.Doctor + '</td></tr>'
		+'<tr><td colspan="5">Hospital: ' + payload.Hospital + '</td>'
		+'		<td colspan="5">Time: ' + timeToString(payload.PatientTime) + '</td></tr>'
	}
	else if(tx.EventType === "newRecord") {
		payloadHTML += ''
		+'<tr><td rowspan="4">Payload: </td><td colspan="5">Hospital: ' + payload.Hid + '</td>'
		+'		<td colspan="5">Doctor: ' + payload.Did + '</td></tr>'
		+'<tr><td colspan="5">Patient: ' + payload.Pid + '</td>'
		+'		<td colspan="5">Time: ' + timeToString(payload.HospitalTime) + '</td></tr>'
		+'<tr><td colspan="10">RecordId: ' + payload.RecordId + '</td></tr>'
		+'<tr><td colspan="5">Diagnose: ' + payload.Zhenduan + '</td>'
		+'		<td colspan="5">Inspections: ' + payload.Jianyan + '</td></tr>'
	}
	else if(tx.EventType === "requestGrant") {
		payloadHTML += ''
		+'<tr><td rowspan="3">Payload:</td><td colspan="5">RequestDoctor: ' + payload.RequestDoctor +'</td>'
		+'		<td colspan="5">RequestHospital: ' + payload.RequestHospital + '</td></tr>'
		+'<tr><td colspan="5">Patient: ' + payload.Patient + '</td>'
		+'		<td colspan="5">TargetHospital: ' + payload.TargetHospital + '</td></tr>'
		+'<tr><td colspan="10">RecordId: ' + payload.RecordId + '</td></tr>'
	}
	return payloadHTML;
};


</script>

</html>
