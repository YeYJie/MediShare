
<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<title>Dashboard Template for Bootstrap</title>

		<link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

		<link href="dashboard.css" rel="stylesheet">
		<link href="signin.css" rel="stylesheet">


	</head>

	<body>

		<nav class="navbar navbar-inverse navbar-fixed-top" id="nav" style="display: none;">
			<div class="container-fluid">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" id="hospital-name">Project name</a>
				</div>
<!--         <div id="navbar" class="navbar-collapse collapse">
					<form class="navbar-form navbar-right">
						<input type="text" class="form-control" placeholder="Search...">
					</form>
				</div>
			</div> -->
		</nav>

		<div class="container-fluid">

					<div class="row" id="before-login">
						<div style="height: 10vh;"></div>
							<div class="col-md-4 col-md-offset-4">
								<div class="panel panel-login">
									<div class="panel-heading">
										<div class="row">
											<div class="col-xs-6">
												<a href="#" class="active" id="login-form-link">登录</a>
											</div>
											<div class="col-xs-6">
												<a href="#" id="register-form-link">注册</a>
											</div>
										</div>
										<hr>
									</div>
									<div class="panel-body">
										<div class="row">
											<div class="col-lg-12">


												<div id="login-form" style="display: block;">
													<div class="form-group">
														<input type="text" name="username" id="login-id" tabindex="1" class="form-control" placeholder="Id" value="">
													</div>
													<div class="form-group">
														<input type="password" name="password" id="login-pwd" tabindex="2" class="form-control" placeholder="Password">
													</div>
													<div class="form-group">
														<div class="row">
															<div class="col-sm-6 col-sm-offset-3">
															<button id="login-button" class="btn btn-lg btn-primary btn-block" type="submit">登录</button>
															</div>
														</div>
													</div>
												</div>



												<div id="register-form" style="display: none;">
													<div class="form-group">
														<input type="text" id="signupId" class="form-control" placeholder="Username" value="">
													</div>
													<div class="form-group">
														<input type="password" id="signupPwd" class="form-control" placeholder="Password">
													</div>
													<div class="form-group">
														<input type="password" id="confirm-password" class="form-control" placeholder="Confirm Password">
													</div>
													<div class="form-group">
														<input type="email" id="signupEmail" class="form-control" placeholder="Email Address" value="">
													</div>
													<div class="form-group">
														<input type="text" id="signupPhone" class="form-control" placeholder="Phone" value="">
													</div>
													<div class="form-group">
														<input type="text" id="signupAddr" class="form-control" placeholder="Address" value="">
													</div>
													<div class="form-group">
														<div class="row">
															<div class="col-sm-6 col-sm-offset-3">
																<button id="signup-button" class="btn btn-lg btn-primary btn-block" type="submit">REGISTER NOW</button>
															</div>
														</div>
													</div>
												</div>


											</div>
										</div>
									</div>
								</div>
							</div>
					</div>

 <!--      <div class="form-signin" id="before-login">
				<h2 class="form-signin-heading">Doctor Page</h2>

				<p>
				<label for="login-id" class="sr-only">Id</label>
				<input type="text" id="login-id" class="form-control" placeholder="Id">
				</p>
				<p>

				<label for="login-pwd" class="sr-only">Password</label>
				<input type="password" id="login-pwd" class="form-control" placeholder="Password">
				</p>

				<p><button id="login-button" class="btn btn-lg btn-primary btn-block" type="submit">Login</button></p>
				<p><button id="signup-button" class="btn btn-lg btn-primary btn-block" type="submit">Signin</button></p>
			</div> -->



			<div class="row" id="after-login" style="display: none;">


				<div class="col-sm-3 col-md-2 sidebar">

							<div id="doctorInfo" class="col-sm-3 col-md-2 sidebar" style="display: block;">
									<div class="row">
										<div class="col-md-6 col-md-offset-3">
											<ul id="doctorInfoHeader" class="nav nav-sidebar"></ul>
										</div>
									</div>

									<ul id="doctorInfoDetail" class="nav nav-sidebar"></ul>

									<div class="row">
									<ul id="doctorInfoEdit" class="nav nav-sidebar">
												<!-- <li><a><button id="doctorInfoEdit-button" class="btn btn-default btn-lg btn-block">Edit</button></a></li> -->
												<li><a><button id="doctorInfoEdit-logout-button" class="btn btn-default btn-lg btn-block">登出</button></a></li>
									</ul>
									</div>

							</div>

							<div id="patientInfo" class="col-sm-3 col-md-2 sidebar" style="display: none;">
									<div class="row">
										<div class="col-md-6 col-md-offset-3">
								<ul id="patientInfoHeader" class="nav nav-sidebar"></ul>
										</div>
									</div>
								<ul id="patientInfoDetail" class="nav nav-sidebar"></ul>
							 </div>

				</div>

				<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">




		<div id="patientList" style="display: block;">
			<h1 class="page-header">挂号病人</h1>
				<table id="patientList-table" class="table table-striped">
				<thead>
						<th>姓名</th>
						<th></th>
				</thead>
				<tbody>
				</tbody>
				</table>
		</div>



		<div id="patientRecords" style="display: none;">
		 <div id="patientRecords-record">
			<h1 class="page-header">病历记录</h1>
			<table id="patientRecords-table" class="table table-striped">
			<thead>
					<th>医院</th>
					<th>医生</th>
					<th>时间</th>
					<th>检查项目</th>
					<th></th>
			</thead>
			<tbody></tbody>
			</table>
		 </div>


<div class="row" id="patientRecords-diagnose">
	<div style="position: fixed; right: 50px; bottom: 50px; height: 100px; width: 300px;">
		<p><button id="patientRecords-diagnose-button" class="btn btn-lg btn-primary btn-block">诊疗</button></p>
		<p><button id="patientRecords-goback" class="btn btn-lg btn-primary btn-block">返回</button></p>
	</div>
</div>


		</div>



		<div id="diagnose" style="display: none;">
			<div id="diagnose-inspection"></div>
			<div class="row"><div style="height: 3vh;"></div></div>

					<div class="row">
						<div class="col-md-12">
							<div class="form-group">
								<label for="diagnoseInspection"><h3>诊断项目</h3></label>
								<textarea class="form-control" id="diagnoseInspection" rows="3"></textarea>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-12">
							<div class="form-group">
								<label for="diagnoseSymptom"><h3>症状</h3></label>
								<textarea class="form-control" id="diagnoseSymptom" rows="3"></textarea>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-12">
							<div class="form-group">
								<label for="diagnoseAnalysis"><h3>诊疗分析</h3></label>
								<textarea class="form-control" id="diagnoseAnalysis" rows="3"></textarea>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-12">
							<div class="form-group">
								<label for="diagnosePrescription"><h3>处方</h3></label>
								<textarea class="form-control" id="diagnosePrescription" rows="3"></textarea>
							</div>
						</div>
					</div>

					<div class="row">
						<div style="position: fixed; right: 50px; bottom: 50px; height: 100px; width: 300px;">
							<p><button id="diagnose-submit" class="btn btn-lg btn-primary btn-block">提交</button></p>
							<p><button id="diagnose-goback" class="btn btn-lg btn-primary btn-block">返回</button></p>
						</div>
					</div>

		</div>


		<div id="recordDetail" style="display: none;">
			<h1 class="page-header">记录详情</h1>
			<div id="recordDetail-div"></div>
			<!-- <p><button id="recordDetail-goback" class="btn btn-lg btn-default btn-block">返回</button></p> -->

	<div class="row">
		<div style="position: fixed; right: 50px; bottom: 0px; height: 100px; width: 300px;">
			<p><button id="recordDetail-goback" class="btn btn-lg btn-primary btn-block">返回</button></p>
		</div>
	</div>

		</div>


				</div>
			</div>
		</div>


		<script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
		<script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>
		<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>


	</body>
	 <script src="/socket.io/socket.io.js"></script>

	 <script type="text/javascript">


	$(function () {

		$('#login-form-link').click(function(e) {
		$("#login-form").delay(100).fadeIn(100);
		$("#register-form").fadeOut(100);
		$('#register-form-link').removeClass('active');
		$(this).addClass('active');
		e.preventDefault();
	});
	$('#register-form-link').click(function(e) {
		$("#register-form").delay(100).fadeIn(100);
		$("#login-form").fadeOut(100);
		$('#login-form-link').removeClass('active');
		$(this).addClass('active');
		e.preventDefault();
	});

		var socket = io();
		var globalDid = "123456";
		var globalPid;

		var patientInspection = new Map;
		socket.on('newInspection', function(data){
			console.log("newInspection", data);
			var inspection = data.data;
			// patientInspection[inspection.pid].push(inspection);
			if(patientInspection[inspection.pid])
				patientInspection[inspection.pid].push(inspection);
			else
				patientInspection[inspection.pid] = [inspection];
			console.log('newInspection patientInspection[inspection.pid]: ',
										patientInspection[inspection.pid]);
			document.getElementById("diagnose-inspection").innerHTML = buildInspection(globalPid);
		});



		var buildDetail = function(detail) {
			var analysis = detail.analysis;
			var did = detail.did;
			var files = detail.files;
			var inspection = detail.inspection;
			var inspections = JSON.parse(detail.inspections);
			var pid = detail.pid;
			var prescription = detail.prescription;
			var result = detail.result;
			var rid = detail.rid;

			var res = '<div class="row">'
			+'	<div class="col-md-12">'
			+'		<div class="form-group">'
			+'			<label for="diagnoseInspection"><h3>诊断项目</h3></label>'
			+'			<textarea class="form-control" id="diagnoseInspection" rows="3" readonly>' + detail.inspection + '</textarea>'
			+'		</div>'
			+'	</div>'
			+'</div>'
			+'<div class="row">'
			+'	<div class="col-md-12">'
			+'		<div class="form-group">'
			+'			<label for="diagnoseSymptom"><h3>症状</h3></label>'
			+'			<textarea class="form-control" id="diagnoseSymptom" rows="3" readonly>' + detail.symptom + '</textarea>'
			+'		</div>'
			+'	</div>'
			+'</div>'
			+'<div class="row">'
			+'	<div class="col-md-12">'
			+'		<div class="form-group">'
			+'			<label for="diagnoseAnalysis"><h3>诊疗分析</h3></label>'
			+'			<textarea class="form-control" id="diagnoseAnalysis" rows="3" readonly>' + detail.analysis + '</textarea>'
			+'		</div>'
			+'	</div>'
			+'</div>'
			+'<div class="row">'
			+'	<div class="col-md-12">'
			+'		<div class="form-group">'
			+'			<label for="diagnosePrescription"><h3>处方</h3></label>'
			+'			<textarea class="form-control" id="diagnosePrescription" rows="3" readonly>' + detail.prescription + '</textarea>'
			+'		</div>'
			+'	</div>'
			+'</div>';

			if(!inspections) return res;
			inspections.forEach(function(ins){
				res += insToHTML(ins);
			});
			return res;
		};


		var insToHTML = function(ins) {
				var res = '<div class="row"><div style="height: 3vh;"></div></div>'
							+ '<div class="row"><div class="col-md-10 col-md-offset-1">'
							+ '<div style="border-radius: 25px; border: 2px solid #428bca;">'
							+ '<div class="row"><div class="col-md-10 col-md-offset-1">';

				res	+=  '<div class="row">'
							+ '	<div class="col-md-12">'
							+ '		<div class="form-group">'
							+ '			<label for="inspection"><h3>检验项目</h3></label>'
							+ '			<textarea class="form-control" id="inspection" rows="3" readonly>' + ins.inspection + '</textarea>'
							+ '  	</div>'
							+ '	</div>'
							+ '</div>'
							+ ''
							+ '<div class="row">'
							+ '	<div class="col-md-12">'
							+ '		<div class="form-group">'
							+ '			<label for="resultText"><h3>检验结果</h3></label>'
							+ '			<textarea class="form-control" id="resultText" rows="3" readonly>' + ins.resultText + '</textarea>'
							+ '		</div>'
							+ '		<div class="form-group">'
							+ '			<div id="resultFile">';
													ins.resultFiles.forEach(function(f){
														res += '<img src="' + f + '" />';
													});
				 res += '			</div>'
							+ '		</div>'
							+ '	</div>'
							+ '</div>'
							+ ''
							+ '<div class="row">'
							+ '	<div class="col-md-12">'
							+ '		<div class="form-group">'
							+ '			<label for="reportText"><h3>检验报告</h3></label>'
							+ '			<textarea class="form-control" id="reportText" rows="3" readonly>' + ins.reportText + '</textarea>'
							+ '		</div>'
							+ '		<div class="form-group">'
							+ '			<div id="reportFile">';
													ins.reportFiles.forEach(function(f){
														res += '<img src="' + f + '" />';
													});
				 res += '			</div>'
							+ '		</div>'
							+ '	</div>'
							+ '</div>'
							+ '</div>';
				res += '</div></div></div></div></div>';
				return res;
		}


		var buildInspection = function(pid) {
			console.log("buildInspection", pid, patientInspection[pid]);
			var inspections = patientInspection[pid];
			var res = "";
			if(!inspections) return res;
			inspections.forEach(function(ins){
				res += insToHTML(ins);
			});
			return res;
		};

		$("#recordDetail-goback").click(function(){
			document.getElementById("recordDetail").style.display = "none";
			document.getElementById("patientRecords").style.display = "block";
		});

		$(".diagnose").click(function(){
			document.getElementById("doctorInfo").style.display = "none";
			document.getElementById("patientInfo").style.display = "block";
			document.getElementById("patientList").style.display = "none";
			document.getElementById("patientRecords").style.display = "block";
		});
		$("#patientRecords-diagnose-button").click(function(){
			document.getElementById("patientRecords").style.display = "none";
			document.getElementById("diagnose").style.display = "block";

			document.getElementById("diagnose-inspection").innerHTML = buildInspection(globalPid);

		});
		$("#patientRecords-referral-button").click(function(){
			document.getElementById("patientRecords").style.display = "none";
			document.getElementById("referral").style.display = "block";
		});
		$("#patientRecords-goback").click(function(){
			document.getElementById("patientRecords").style.display = "none";
			document.getElementById("patientInfo").style.display = "none";
			document.getElementById("patientList").style.display = "block";
			document.getElementById("doctorInfo").style.display = "block";
			$("#patientRecords-table").find("tr:gt(0)").remove();
		});

		$("#diagnose-submit").click(function(){
			document.getElementById("diagnose").style.display = "none";
			document.getElementById("patientRecords").style.display = "block";

			console.log('diagnose-submit-button click', [globalDid, globalPid]);
			var formData = new FormData();
			formData.append('did', globalDid);
			formData.append('pid', globalPid);

			formData.append('inspections', JSON.stringify(patientInspection[globalPid]));
			formData.append('inspection', $("#diagnoseInspection").val());
			formData.append('symptom', $("#diagnoseSymptom").val());
			formData.append('analysis', $("#diagnoseAnalysis").val());
			formData.append('prescription', $("#diagnosePrescription").val());
			$("#diagnoseInspection").val(); $("#diagnoseSymptom").val(); $("#diagnoseAnalysis").val(); $("#diagnosePrescription").val();

			// $.each($("#uploadFile")[0].files, function(i, file) {
			// 		formData.append('file', file);
			// });
			console.log(formData);

			$.ajax({
				type: "POST",
				url: "/upload",
				data: formData,
				contentType: false,
				processData: false,
				success: function(text) {
					console.log(text);
					// console.log(text);
					return false;
				},
				error: function(xhr) {
				}
			});
		});
		$("#diagnose-goback").click(function(){
			document.getElementById("diagnose").style.display = "none";
			document.getElementById("patientRecords").style.display = "block";
		});

		$(".referral-submit").click(function(){
			document.getElementById("referral").style.display = "none";
			document.getElementById("patientInfo").style.display = "none";
			document.getElementById("doctorInfo").style.display = "block";
			document.getElementById("patientList").style.display = "block";
		});
		$("#referral-goback").click(function(){
			document.getElementById("referral").style.display = "none";
			document.getElementById("patientRecords").style.display = "block";
		});

		$("#doctorInfoEdit-button").click(function(){
			document.getElementById("patientList").style.display = "none";
			document.getElementById("doctorInfo").style.display = "none";
			document.getElementById("doctorEdit").style.display = "block";
		});
		$("#doctorInfoEdit-logout-button").click(function(){
			// document.getElementById("doctorInfo").style.display = "none";
			// document.getElementById("patientList").style.display = "none";

			document.getElementById("nav").style.display = "none";
			document.getElementById("before-login").style.display = "block";
			document.getElementById("after-login").style.display = "none";
			$("#patientList-table").find("tr:gt(0)").remove();
			socket.emit("doctorLogout", {did: globalDid});
		});
		$("#doctorEdit-submit").click(function(){
			// socket.emit('doctorEdit', {id: $('#editId'), pwd: $('#editPwd'), phone: $('#editPhone'), email: $('#editEmail'), addr: $('#editAddr')});
			$('#editPwd').val(); $('#editPhone').val(); $('#editEmail').val(); $('#editAddr').val();
			document.getElementById("doctorInfo").style.display = "block";
			document.getElementById("patientList").style.display = "block";
			document.getElementById("doctorEdit").style.display = "none";
		});

		$('#login-button').click(function(){
			globalDid = $('#login-id').val().toString();
			socket.emit('login', {id: globalDid, pwd: $('#login-pwd').val()})
			$('#login-id').val(""); $('#login-pwd').val("");
			// document.getElementById("outer-wrap").style.display = "none";
			document.getElementById("before-login").style.display = "none";
			document.getElementById("after-login").style.display = "block";
			document.getElementById("nav").style.display = "block";
			document.getElementById("doctorInfo").style.display = "block";
			document.getElementById("patientList").style.display = "block";
		});
		// $('#signup-button').click(function(){
		//   document.getElementById("login").style.display = "none";
		//   document.getElementById("signup").style.display = "block";
		// });
		$('#signup-goback').click(function(){
			document.getElementById("login").style.display = "block";
			document.getElementById("signup").style.display = "none";
		});
		$('#signup-button').click(function(){
			socket.emit('signup', {role: "doctor", id: $('#signupId').val(), name: $('#signupName').val(), pwd: $('#signupPwd').val(), phone: $('#signupPhone').val(), email: $('#signupEmail').val(), addr: $('#signupAddr').val()});
			$('#signupId').val(); $('#signupName').val(); $('#signupPwd').val(); $('#signupPhone').val(); $('#signupEmail').val(); $('#signupAddr').val();
			document.getElementById("signup").style.display = "none";
			document.getElementById("signupState").style.display = "block";
		});
		$('#state-button').click(function() {
			socket.emit('signupState', {role: "doctor", id: $('#stateId').val()});
			$('#stateId').val('');
			document.getElementById("signup").style.display = "none";
			document.getElementById("signupState").style.display = "block";
		});
		$('#signupState-goback').click(function(){
			document.getElementById("signupState").style.display = "none";
			document.getElementById("login").style.display = "block";
			document.getElementById('signupStateDiv').innerHTML = "Please Wait for Review";
		});

		socket.on('signUpSuccess', function(data){
			var signUpSuccessHTML = '<p>Hello, ' + data.name + '</p>'
					+ '<p>Your Private Key: ' + data.prikey + '</p>'
					+ '<p>Your PKC: ' + data.pkc + '</p>';
			console.log(signUpSuccessHTML);
			document.getElementById('signupStateDiv').innerHTML = signUpSuccessHTML;
		});
		socket.on('doctorInfo', function(data){
			console.log('doctorInfo', data);
			var doctorInfo = JSON.parse(data.doctorInfo);
			document.getElementById("doctorInfoHeader").innerHTML = '<li><a><img src="/header/'+doctorInfo.id + '" /></a></li>';
			var doctorInfoDetailHTML = '<li><a>姓名: ' + doctorInfo.name + '</a></li>';
			doctorInfoDetailHTML += '<li><a>科室: ' + doctorInfo.keshi + '</a></li>';
			doctorInfoDetailHTML += '<li><a>职位: ' + doctorInfo.title + '</a></li>';
			doctorInfoDetailHTML += '<li><a>电话: ' + doctorInfo.phone + '</a></li>';
			doctorInfoDetailHTML += '<li><a>邮箱: ' + doctorInfo.email + '</a></li>';
			doctorInfoDetailHTML += '<li><a>住址: ' + doctorInfo.addr + '</a></li>';
			document.getElementById("doctorInfoDetail").innerHTML = doctorInfoDetailHTML;
			document.getElementById("hospital-name").innerHTML = data.hospitalName;
		});

		var myPatients = [];
		var buildPatientHTML = function(patient) {
			var index = myPatients.indexOf(patient.id);
			if(index > -1) return null;
			myPatients.push(patient.id);
			return '<tr><td>' + patient.name + '</td><td><button id="patientList-'+patient.id
			 +'" data-pid="'+patient.id+'" class="btn btn-default btn-lg btn-block">诊疗</button></td></tr>';
		};
		socket.on('doctorPatients', function(data){
			console.log('doctorPatients', data);
			var patients = data.patients;
			console.log(patients);

			for(var i = 0; i < patients.length; i++) {
				var patientHTML = buildPatientHTML(patients[i]);
				if(!patientHTML) continue;
				var row = document.getElementById("patientList-table").insertRow(1);
				row.innerHTML = patientHTML;
				$('#patientList-' + patients[i].id.toString()).click(function(){
					var patientId = $(this).data('pid').toString();
					globalPid = patientId;
					console.log(globalPid);
					socket.emit('getPatientRecords', {patientId: patientId, doctorId: globalDid});
					document.getElementById("patientList").style.display = "none";
					document.getElementById("patientRecords").style.display = "block";
				});
			}
		});
		socket.on('patientInfo', function(data){
			console.log('patientInfo', data);
			var patientInfo = JSON.parse(data.patientInfo);
			document.getElementById("patientInfoHeader").innerHTML = '<img src="/header/'+patientInfo.id + '" />';
			var patientInfoDetailHTML = '<li><a>姓名: ' + patientInfo.name + '</a></li>';
			patientInfoDetailHTML += '<li><a>电话: ' + patientInfo.phone + '</a></li>';
			patientInfoDetailHTML += '<li><a>邮箱: ' + patientInfo.email + '</a></li>';
			patientInfoDetailHTML += '<li><a>住址: ' + patientInfo.addr + '</a></li>';
			document.getElementById("patientInfoDetail").innerHTML = patientInfoDetailHTML;
			document.getElementById("doctorInfo").style.display = "none";
			document.getElementById("patientInfo").style.display = "block";
		});

		var hospitalIdToName = function(hid) {
			if(hid === "1") return "省中医";
			else if(hid === "2") return "市六医院";
			else return "未知医院";
		}

		socket.on('patientRecords', function(data){
			$("#patientRecords-table").find("tr:gt(0)").remove();
			console.log('patientRecords', data);
			var patientRecords = data.records;
			var buildRecordHTML = function(record) {
				var date = new Date(parseInt(record.RecordTime) * 1000);
				var y = date.getFullYear();
				var m = date.getMonth() + 1;
				var d = date.getDate();
				return '<tr><td>' + hospitalIdToName(record.Hospital) + '</td><td>' + record.Doctor
					+ '</td><td>' + y + '-' + m + '-' + d + '</td><td>' + record.Inspection
					+ '</td><td><button id="patientRecord-'+record.RecordId+'" data-rid="'
					+ record.RecordId + '" data-pid="' + data.id + '" data-th="'
					+ record.Hospital + '" class="btn btn-default btn-lg btn-block">查看细节</button></td>';
			};
			if(!patientRecords) return;
			for(var i = 0; i < patientRecords.length; i++) {
				var recordHTML = buildRecordHTML(patientRecords[i]);
				var row = document.getElementById("patientRecords-table").insertRow(1);
				row.innerHTML = recordHTML;
				$("#patientRecord-"+patientRecords[i].RecordId).click(function(){
					var rid = $(this).data('rid').toString();
					var pid = $(this).data('pid').toString();
					var targetHospital = $(this).data('th');
					console.log([rid, pid, targetHospital]);
					socket.emit('requestDetail', {rid: rid, did: globalDid, pid: pid,
											targetHospital: targetHospital});
				});
			}
		});

		socket.on('recordDetail', function(data){
			var detail = JSON.parse(data.recordDetail);
			console.log('recordDetail detail: ', detail);
			document.getElementById("recordDetail-div").innerHTML = buildDetail(detail);
			document.getElementById("recordDetail").style.display = "block";
			document.getElementById("patientRecords").style.display = "none";
		});

		socket.on('event', function(data){
			console.log(data);
			if(data.EventType === "deRegister") {
				var payload = JSON.parse(data.Payload);
				if(payload.Doctor === globalDid) {
					console.log("patient deRegister from me");
					var pid = payload.Patient;
					var index = myPatients.indexOf(pid);
					if(index > -1)
						myPatients.splice(index, 1);
					var row = document.getElementById("patientList-" + pid).parentElement.parentElement;
					console.log(row);
					document.getElementById("patientList-table").deleteRow(row.rowIndex);
				}
			}
			else if(data.EventType === "register") {
				var payload = JSON.parse(data.Payload);
				if(payload.Doctor === globalDid) {
					console.log("patient register to me", payload.Patient);
					var pid = payload.Patient;
					$.ajax({
						type: "GET",
						url: "/getPatientNameFromId/" + pid,
						success: function(text) {
							var patientHTML = buildPatientHTML({id: pid, name: text});
							console.log(patientHTML);
							var row = document.getElementById("patientList-table").insertRow(1);
							row.innerHTML = patientHTML;
							$('#patientList-' + pid).click(function(){
								var patientId = $(this).data('pid').toString();
								globalPid = patientId;
								console.log(globalPid);
								socket.emit('getPatientRecords', {patientId: patientId, doctorId: globalDid});
								document.getElementById("patientList").style.display = "none";
								document.getElementById("patientRecords").style.display = "block";
							});
						},
						error: function(xhr) {
						}
					});
				}
			}
			else if(data.EventType === "newRecord") {
				var payload = JSON.parse(data.Payload);
				if(payload.Doctor === globalDid && payload.Patient === globalPid) {
					console.log("patient has new record");
					socket.emit('getPatientRecords', {doctorId: globalDid, patientId: globalPid});
				}
			}
		});
	})

	 </script>


</html>
