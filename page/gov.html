<!doctype html>
<html>
	<head>
		<style type="text/css">
			table {
			    font-family: arial, sans-serif;
			    border-collapse: collapse;
			    width: 100%;
			}
			td, th {
			    border: 1px solid #dddddd;
			    text-align: left;
			    padding: 8px;
			}
			tr:nth-child(even) {
			    background-color: #dddddd;
			}
			html,body{height: 100%}
			#outer-wrap{
				height: 100%;
				position: relative;
			}
			#login-panel{
				width: 400px;
				height: 300px;
				position: absolute;
				top: 50%;
				left: 50%;
				margin-top: -150px;
				margin-left: -200px;
			}
		</style>
	</head>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script> -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script>


	$(function () {
		var socket = io();

		var buildRowHTML = function(fileId, fileName, fileVersion, fileSize, department, uploader,
							time, needAuthorization, buttonId) {
			var date = new Date(parseInt(time) * 1000);
			var y = date.getFullYear();
			var m = date.getMonth() + 1;
			var d = date.getDate();
			return '<tr><td>' + fileName +'</td>'
					+'<td>' + fileVersion +'</td>'
					+'<td>' + fileSize +'</td>'
					+'<td>' + department +'</td>'
					+'<td>' + uploader +'</td>'
					+'<td>' + y + '-' + m + '-' + d +'</td>'
					+'<td>' + needAuthorization +'</td>'
					+'<td><button id="' + buttonId + '" data-fileId="' + fileId
					+ '" needAuthorization="' + needAuthorization + '">Requset File</button></td></tr>'
		};

		socket.on('fileList', function(data) {
			console.log(data);
			for(var i = 0; i < data.files.length; ++i) {
				console.log(data.files[i]);
				var file = data.files[i];
				var fileHTML = buildRowHTML(file.FileId, file.FileName, file.FileVersion, file.FileSize, file.Department,
								file.Uploader, file.UploadTime, file.NeedAuthorization,
								"fileList-request-button-"+file.FileId);
				var row = document.getElementById("fileList-table").insertRow(1);
				row.innerHTML = fileHTML;
				$('#fileList-request-button-' + file.FileId).click(function(){
					var needAuthorization = $(this).attr('needAuthorization');
					var fileId = $(this).attr('data-fileId');
					if(needAuthorization === "true") {
						console.log("emit requestFileAuthorization " + fileId);
						socket.emit('requestFileAuthorization', {fileId: fileId});
					}
					else {
						console.log("emit requestFile " + fileId);
						socket.emit('requestFile', {fileId: fileId});
					}
				});
			}
		});
		socket.on('searchResult', function(data) {
			console.log(data);
			for(var i = 0; i < data.files.length; ++i) {
				console.log(data.files[i]);
				var file = data.files[i];
				var fileHTML = buildRowHTML(file.FileId, file.FileName, file.FileVersion, file.FileSize, file.Department,
								file.Uploader, file.UploadTime, file.NeedAuthorization,
								"searchResult-request-button-"+file.FileId);
				var row = document.getElementById("searchResult-table").insertRow(1);
				row.innerHTML = fileHTML;
				$('#searchResult-request-button-' + file.FileId).click(function(){
					var needAuthorization = $(this).attr('needAuthorization');
					var fileId = $(this).attr('data-fileId');
					if(needAuthorization === "true") {
						console.log("emit requestFileAuthorization " + fileId);
						socket.emit('requestFileAuthorization', {fileId: fileId});
					}
					else {
						console.log("emit requestFile " + fileId);
						socket.emit('requestFile', {fileId: fileId});
					}
				});
			}
		});
		socket.on('fileEntry', function(data) {
			var entry = data.entry;
			console.log(entry);
			document.getElementById("fileContent").style.display = "block";
			var fileContentHTML = '<img src="' + entry + '"/>'
			document.getElementById("fileContent-p").innerHTML = fileContentHTML;
		});

		$('#fileContent-goback').click(function(){
			document.getElementById("fileContent").style.display = "none";
		})

		$('#login-button').click(function(){
			document.getElementById("outer-wrap").style.display = "none";
			document.getElementById("staffInfo").style.display = "block";
			document.getElementById("fileList").style.display = "block";
			// TODO
			socket.emit('login', {id: $('#login-id').val(), pwd: $('#login-pwd').val()});
			$('#login-id').val("");
			$('#login-pwd').val("");
		})
		$('#fileList-logout').click(function(){
			document.getElementById("outer-wrap").style.display = "block";
			document.getElementById("staffInfo").style.display = "none";
			document.getElementById("fileList").style.display = "none";
			$("#fileList-table").find("tr:gt(0)").remove();
		})
		$('#fileList-search').click(function(){
			document.getElementById("search").style.display = "block";
			document.getElementById("fileList").style.display = "none";
		})
		$('#fileList-upload').click(function(){
			// TODO
			document.getElementById("fileList").style.display = "none";
			document.getElementById("upload").style.display = "block";
		})





		$('#upload-button').click(function(){

			console.log('upload-button click');

			var formData = new FormData();
			formData.append("uploadText", $('#uploadText').val());
			formData.append('uploadFile', $('#uploadFile')[0].files[0]);

			console.log(formData);

			$.ajax({
				type: "POST",
				url: "/upload",
				data: formData,
				contentType: false,
				processData: false,
				success: function(text) {
					// MvcUtil.showSuccessResponse(text, button);
					console.log(text);
					document.getElementById("fileList").style.display = "none";
					document.getElementById("upload").style.display = "block";
					return false;
				},
				error: function(xhr) {
					// MvcUtil.showErrorResponse(xhr.responseText, button);
				}
			});

			return false;
		})





		$('#upload-goback').click(function(){
			document.getElementById("fileList").style.display = "block";
			document.getElementById("upload").style.display = "none";
		})
		$('#search-name-button').click(function(){
			document.getElementById("search").style.display = "none";
			document.getElementById("searchResult").style.display = "block";
			var name = $('#search-name').val();
			$('#search-name').val("");
			console.log('search-name: ' + name);
			socket.emit('searchByName', {name: name});
		})
		$('#search-time-button').click(function(){
			document.getElementById("search").style.display = "none";
			document.getElementById("searchResult").style.display = "block";
			var begin = $('#search-time-begin').val();
			var end = $('#search-time-end').val();
			$('#search-time-begin').val("");
			$('#search-time-end').val("");
			if(begin !== "")
				console.log('search-time-begin: ' + begin);
			if(end !== "")
				console.log('search-time-end: ' + end);
			socket.emit('searchByTime', {begin: begin, end:end});
		})
		$('#search-department-button').click(function(){
			document.getElementById("search").style.display = "none";
			document.getElementById("searchResult").style.display = "block";
			var department = $('#search-department').val();
			var begin = $('#search-department-begin').val();
			var end = $('#search-department-end').val();
			$('#search-department').val("");
			$('#search-department-begin').val("");
			$('#search-department-end').val("");
			console.log('search-department: ' + department);
			if(begin !== "")
				console.log('search-department-begin: ' + begin);
			if(end !== "")
				console.log('search-department-end: ' + end);
			socket.emit('searchByDepartment', {department: department, begin: begin, end:end});
		})
		$('#search-uploader-button').click(function(){
			document.getElementById("search").style.display = "none";
			document.getElementById("searchResult").style.display = "block";
			var uploader = $('#search-uploader').val();
			var begin = $('#search-uploader-begin').val();
			var end = $('#search-uploader-end').val();
			$('#search-uploader').val("");
			$('#search-uploader-begin').val("");
			$('#search-uploader-end').val("");
			console.log('search-uploader: ' + uploader);
			if(begin !== "")
				console.log('search-uploader-begin: ' + begin);
			if(end !== "")
				console.log('search-uploader-end: ' + end);
			socket.emit('searchByUploader', {uploader: uploader, begin: begin, end:end});
		})
		$('#search-goback').click(function(){
			document.getElementById("search").style.display = "none";
			document.getElementById("fileList").style.display = "block";
			$("#searchResult-table").find("tr:gt(0)").remove();
		})
		$('#searchResult-goback').click(function(){
			document.getElementById("searchResult").style.display = "none";
			document.getElementById("search").style.display = "block";
			$("#searchResult-table").find("tr:gt(0)").remove();
		})
	});
</script>
  <body>
	  	<div id="staffInfo" style="display: none;float:left;"></div>

	  	<div id="fileList" style="display: none;float:right; width: 80%">
	  		<ul id="fileList-ul"></ul>
	  		<p><table id="fileList-table">
				<tr>
					<th>FileName</th>
					<th>FileVersion</th>
					<th>FileSize</th>
					<th>Department</th>
					<th>Uploader</th>
					<th>Upload time</th>
					<th>NeedAuthorization</th>
					<th></th>
				</tr>
	  		</table></p>
	  		<p><button id="fileList-search">Search</button></p>
	  		<p><button id="fileList-upload">Upload</button></p>
	  		<p><button id="fileList-logout">Logout</button></p>
	  	</div>







	  	<div id="upload">
	  		<form ref='uploadForm' id='uploadForm' action='/upload' method='post' encType="multipart/form-data">
	  			<input type="text" id="uploadText">
	  			<input type="file" name="sampleFile" id="uploadFile" />
	  			<button id="upload-button">Submit</button>
	  		</form>
	  	</div>





	  	<div id="search" style="display: none;float:right; width: 80%">
  			<p><fieldset>
  				<legend>By Name</legend>
  				<input type="text" id="search-name">
  				<button id="search-name-button">Search</button>
  			</fieldset></p>
    		<p><fieldset>
  				<legend>By Time</legend>
  				<input type="date" id="search-time-begin">
  				<input type="date" id="search-time-end">
  				<button id="search-time-button">Search</button>
  			</fieldset></p>
  			<p><fieldset>
  				<legend>By Department</legend>
  				<input type="text" id="search-department">
  				<input type="date" id="search-department-begin">
  				<input type="date" id="search-department-end">
  				<button id="search-department-button">Search</button>
  			</fieldset></p>
  			<p><fieldset>
  				<legend>By Uploader</legend>
  				<input type="text" id="search-uploader">
  				<input type="date" id="search-uploader-begin">
  				<input type="date" id="search-uploader-end">
  				<button id="search-uploader-button">Search</button>
  			</fieldset></p>
	  		<button id="search-goback">Go Back</button>
	  	</div>

	  	<div id="searchResult" style="display: none;float:right; width: 80%">
	  		<p><table id="searchResult-table">
				<tr>
					<th>FileName</th>
					<th>FileVersion</th>
					<th>FileSize</th>
					<th>Department</th>
					<th>Uploader</th>
					<th>Upload time</th>
					<th>NeedAuthorization</th>
					<th></th>
				</tr>
	  		</table></p>
	  		<button id="searchResult-goback">Go Back</button>
	  	</div>

	  	<div id="fileContent" style="display: none; position:fixed; width:100%; height:100%; background-color:#FFF;">
	  		<p id="fileContent-p"></p>
	  		<p><button id="fileContent-goback">Go Back</button></p>
	  	</div>

		<div id="outer-wrap">
			<div id="login-panel">
			  	<p><input id="login-id" autocomplete="off" /></p>
			  	<p><input id="login-pwd" autocomplete="off" /></p>
			  	<p><button id="login-button">Login</button></p>
			</div>
		</div>
  </body>
</html>
