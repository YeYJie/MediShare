<!doctype html>
<html>
   <head>
	  <style type="text/css">
		 table {
		 font-family: arial, sans-serif;
		 border-collapse: collapse;
		 width: 100%;
		 }
		 td, th {
		 border: 1px solid #dddddd;
		 text-align: left;
		 padding: 8px;
		 }
		 tr:nth-child(even) {
		 background-color: #dddddd;
		 }
		 html,body{height: 100%}
		 #outer-wrap{
		 height: 100%;
		 position: relative;
		 }
		 #login{
		 width: 400px;
		 height: 300px;
		 position: absolute;
		 top: 50%;
		 left: 50%;
		 margin-top: -150px;
		 margin-left: -200px;
		 }
	  </style>
   </head>
   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
   <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
   <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script> -->
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
   <script src="/socket.io/socket.io.js"></script>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
   <script></script>
   <body>
	  <div id="outer-wrap">
		 <div id="login">
			<p><input id="login-id" autocomplete="off" /></p>
			<p><input id="login-pwd" autocomplete="off" /></p>
			<p><button id="login-button">Login</button></p>
			<p><button id="signup-button">Signin</button></p>
		 </div>
		 <div id="signup" style="display: none;">
			<p><fieldset><legend>Id</legend><input type="text" name="id" id="signupId"></fieldset></p>
			<p><fieldset><legend>Name</legend><input type="text" name="name" id="signupName"></fieldset></p>
			<p><fieldset><legend>Password</legend><input type="text" name="pwd" id="signupPwd"></fieldset></p>
			<p><fieldset><legend>Phone</legend><input type="text" name="phone" id="signupPhone"></fieldset></p>
			<p><fieldset><legend>Email</legend><input type="text" name="email" id="signupEmail"></fieldset></p>
			<p><fieldset><legend>Addr</legend><input type="text" name="addr" id="signupAddr"></fieldset></p>
			<p><button id="signup-submit-button">Submit</button></p>
			<p><fieldset><legend>Id</legend><input type="text" name="stateId" id="stateId"></fieldset></p>
			<p><button id="state-button">State</button></p>
			<p><button id="signup-goback">Go Back</button></p>
		 </div>
		 <div id="signupState" style="display: none;">
			<div id="signupStateDiv">Please Wait for Review</div>
			<p><button id="signupState-goback">Go Back</button></p>
		 </div>
	  </div>
	  <div id="doctorInfo" style="display: none;">
		 <div id="doctorInfoHeader"></div>
		 <div id="doctorInfoDetail">
		 </div>
		 <div id="doctorInfoEdit">
			<p><button id="doctorInfoEdit-button">Edit</button></p>
			<p><button id="doctorInfoEdit-logout-button">Logout</button></p>
		 </div>
	  </div>
	  <div id="doctorEdit" style="display: none;">
		 <p><fieldset><legend>Id</legend>123456789</fieldset></p>
		 <p><fieldset><legend>Password</legend><input type="text" name="pwd" id="editPwd"></fieldset></p>
		 <p><fieldset><legend>Phone</legend><input type="text" name="phone" id="editPhone"></fieldset></p>
		 <p><fieldset><legend>Email</legend><input type="text" name="email" id="editEmail"></fieldset></p>
		 <p><fieldset><legend>Addr</legend><input type="text" name="addr" id="editAddr"></fieldset></p>
		 <p><button id="doctorEdit-submit">Submit</button></p>
	  </div>
	  <div id="patientList" style="display: none;">
			<p><h2>Patient List</h2></p>
			<table id="patientList-table">
				<tr>
					<th>Patient Name</th>
					<th></th>
				</tr>
			</table>
	  </div>
	  <div id="patientInfo" style="display: none;">
		 <div id="patientInfoHeader"></div>
		 <div id="patientInfoDetail">
		 </div>
	  </div>
	  <div id="patientRecords" style="display: none;">
		 <div id="patientRecords-record">
			<p><h2>Patient Records</h2></p>
			<table id="patientRecords-table">
				<tr>
					<th>Hospital</th>
					<th>Doctor</th>
					<th>Time</th>
					<th>Inspection</th>
					<th></th>
				</tr>
			</table>
		 </div>
		 <div id="patientRecords-diagnose">
			<p><button id="patientRecords-diagnose-button">Diagnose</button></p>
			<p><button id="patientRecords-referral-button">Referral</button></p>
			<p><button id="patientRecords-goback">Go Back</button></p>
		 </div>
	  </div>
	  <div id="diagnose" style="display: none;">
		 <p><fieldset><legend>Inspection</legend><input type="text" name="inspection" id="diagnoseInspection"></fieldset></p>
		 <p><fieldset><legend>Result</legend><input type="text" name="result" id="diagnoseResult"></fieldset></p>
		 <p><fieldset><legend>Analysis</legend><input type="text" name="analysis" id="diagnoseAnalysis"></fieldset></p>
		 <p><fieldset><legend>Prescription</legend><input type="text" name="prescription" id="diagnosePrescription"></fieldset></p>
		 <p><input type="file" name="sampleFile" id="uploadFile" multiple/></p>
		 <p><button id="diagnose-submit">Submit</button></p>
		 <p><button id="diagnose-goback">Go Back</button></p>
	  </div>
	  <div id="referral" style="display: none;">
		 <p><h2>Hospital List</h2></p>
		 <p>hospital1<button class="referral-submit">Submit</button></p>
		 <p>hospital2<button class="referral-submit">Submit</button></p>
		 <p>hospital3<button class="referral-submit">Submit</button></p>
		 <p><button id="referral-goback">Go Back</button></p>
	  </div>
	  <div id="recordDetail" style="display: none;">
	  	<div id="recordDetail-div"></div>
	  	<p><button id="recordDetail-goback">Go Back</button></p>
	  </div>
   </body>
   <script type="text/javascript">
	$(function () {
		var socket = io();
		var globalDid = "123456";
		var globalPid;

		$("#recordDetail-goback").click(function(){
			document.getElementById("recordDetail").style.display = "none";
			document.getElementById("patientRecords").style.display = "block";
		});

		$(".diagnose").click(function(){
			document.getElementById("doctorInfo").style.display = "none";
			document.getElementById("patientInfo").style.display = "block";
			document.getElementById("patientList").style.display = "none";
			document.getElementById("patientRecords").style.display = "block";
		});
		$("#patientRecords-diagnose-button").click(function(){
			document.getElementById("patientRecords").style.display = "none";
			document.getElementById("diagnose").style.display = "block";
		});
		$("#patientRecords-referral-button").click(function(){
			document.getElementById("patientRecords").style.display = "none";
			document.getElementById("referral").style.display = "block";
		});
		$("#patientRecords-goback").click(function(){
			document.getElementById("patientRecords").style.display = "none";
			document.getElementById("patientInfo").style.display = "none";
			document.getElementById("patientList").style.display = "block";
			document.getElementById("doctorInfo").style.display = "block";
			$("#patientRecords-table").find("tr:gt(0)").remove();
		});

		$("#diagnose-submit").click(function(){
			document.getElementById("diagnose").style.display = "none";
			document.getElementById("patientRecords").style.display = "block";

			console.log('diagnose-submit-button click', [globalDid, globalPid]);
			var formData = new FormData();
			formData.append('did', globalDid);
			formData.append('pid', globalPid);
			formData.append('inspection', $("#diagnoseInspection").val());
			formData.append('result', $("#diagnoseResult").val());
			formData.append('analysis', $("#diagnoseAnalysis").val());
			formData.append('prescription', $("#diagnosePrescription").val());
			$("#diagnoseInspection").val(); $("#diagnoseResult").val(); $("#diagnoseAnalysis").val(); $("#diagnosePrescription").val();
			$.each($("#uploadFile")[0].files, function(i, file) {
			    formData.append('file', file);
			});
			console.log(formData);

			$.ajax({
				type: "POST",
				url: "/upload",
				data: formData,
				contentType: false,
				processData: false,
				success: function(text) {
					console.log(text);
					// console.log(text);
					return false;
				},
				error: function(xhr) {
				}
			});
		});
		$("#diagnose-goback").click(function(){
			document.getElementById("diagnose").style.display = "none";
			document.getElementById("patientRecords").style.display = "block";
		});

		$(".referral-submit").click(function(){
			document.getElementById("referral").style.display = "none";
			document.getElementById("patientInfo").style.display = "none";
			document.getElementById("doctorInfo").style.display = "block";
			document.getElementById("patientList").style.display = "block";
		});
		$("#referral-goback").click(function(){
			document.getElementById("referral").style.display = "none";
			document.getElementById("patientRecords").style.display = "block";
		});

		$("#doctorInfoEdit-button").click(function(){
			document.getElementById("patientList").style.display = "none";
			document.getElementById("doctorInfo").style.display = "none";
			document.getElementById("doctorEdit").style.display = "block";
		});
		$("#doctorInfoEdit-logout-button").click(function(){
			document.getElementById("doctorInfo").style.display = "none";
			document.getElementById("patientList").style.display = "none";
			document.getElementById("outer-wrap").style.display = "block";
			$("#patientList-table").find("tr:gt(0)").remove();
		});
		$("#doctorEdit-submit").click(function(){
			// socket.emit('doctorEdit', {id: $('#editId'), pwd: $('#editPwd'), phone: $('#editPhone'), email: $('#editEmail'), addr: $('#editAddr')});
			$('#editPwd').val(); $('#editPhone').val(); $('#editEmail').val(); $('#editAddr').val();
			document.getElementById("doctorInfo").style.display = "block";
			document.getElementById("patientList").style.display = "block";
			document.getElementById("doctorEdit").style.display = "none";
		});

		$('#login-button').click(function(){
			globalDid = $('#login-id').val();
			socket.emit('login', {id: globalDid, pwd: $('#login-pwd').val()})
			$('#login-id').val(""); $('#login-pwd').val("");
			document.getElementById("outer-wrap").style.display = "none";
			document.getElementById("doctorInfo").style.display = "block";
			document.getElementById("patientList").style.display = "block";
		});
		$('#signup-button').click(function(){
			document.getElementById("login").style.display = "none";
			document.getElementById("signup").style.display = "block";
		});
		$('#signup-goback').click(function(){
			document.getElementById("login").style.display = "block";
			document.getElementById("signup").style.display = "none";
		});
		$('#signup-submit-button').click(function(){
			socket.emit('signup', {role: "doctor", id: $('#signupId').val(), name: $('#signupName').val(), pwd: $('#signupPwd').val(), phone: $('#signupPhone').val(), email: $('#signupEmail').val(), addr: $('#signupAddr').val()});
			$('#signupId').val(); $('#signupName').val(); $('#signupPwd').val(); $('#signupPhone').val(); $('#signupEmail').val(); $('#signupAddr').val();
			document.getElementById("signup").style.display = "none";
			document.getElementById("signupState").style.display = "block";
		});
		$('#state-button').click(function() {
			socket.emit('signupState', {role: "doctor", id: $('#stateId').val()});
			$('#stateId').val('');
			document.getElementById("signup").style.display = "none";
			document.getElementById("signupState").style.display = "block";
		});
		$('#signupState-goback').click(function(){
			document.getElementById("signupState").style.display = "none";
			document.getElementById("login").style.display = "block";
			document.getElementById('signupStateDiv').innerHTML = "Please Wait for Review";
		});

		socket.on('signUpSuccess', function(data){
			var signUpSuccessHTML = '<p>Hello, ' + data.name + '</p>'
					+ '<p>Your Private Key: ' + data.prikey + '</p>'
					+ '<p>Your PKC: ' + data.pkc + '</p>';
			console.log(signUpSuccessHTML);
			document.getElementById('signupStateDiv').innerHTML = signUpSuccessHTML;
		});
		socket.on('doctorInfo', function(data){
			console.log('doctorInfo', data);
			var doctorInfo = JSON.parse(data.doctorInfo);
			document.getElementById("doctorInfoHeader").innerHTML = '<img src="'+doctorInfo.header + '" />';
			var doctorInfoDetailHTML = '<p>Name: ' + doctorInfo.name + '</p>';
			doctorInfoDetailHTML += '<p>Phone: ' + doctorInfo.phone + '</p>';
			doctorInfoDetailHTML += '<p>Email: ' + doctorInfo.email + '</p>';
			doctorInfoDetailHTML += '<p>Addr: ' + doctorInfo.addr + '</p>';
			document.getElementById("doctorInfoDetail").innerHTML = doctorInfoDetailHTML;
		});
		var buildPatientHTML = function(patient) {
			return '<tr><td>' + patient.name + '</td><td><button id="patientList-'+patient.id
			 +'" data-pid="'+patient.id+'">Diagnose</button></td></tr>';
		};
		socket.on('doctorPatients', function(data){
			console.log('doctorPatients', data);
			var patients = data.patients;
			console.log(patients);

			for(var i = 0; i < patients.length; i++) {
				var patientHTML = buildPatientHTML(patients[i]);
				var row = document.getElementById("patientList-table").insertRow(1);
				row.innerHTML = patientHTML;
				$('#patientList-' + patients[i].id.toString()).click(function(){
					var patientId = $(this).data('pid').toString();
					globalPid = patientId;
					console.log(globalPid);
					socket.emit('getPatientRecords', {patientId: patientId, doctorId: globalDid});
					document.getElementById("patientList").style.display = "none";
					document.getElementById("patientRecords").style.display = "block";
				});
			}
		});
		socket.on('patientInfo', function(data){
			console.log('patientInfo', data);
			var patientInfo = JSON.parse(data.patientInfo);
			document.getElementById("patientInfoHeader").innerHTML = '<img src="'+patientInfo.header + '" />';
			var patientInfoDetailHTML = '<p>Name: ' + patientInfo.name + '</p>';
			patientInfoDetailHTML += '<p>Phone: ' + patientInfo.phone + '</p>';
			patientInfoDetailHTML += '<p>Email: ' + patientInfo.email + '</p>';
			patientInfoDetailHTML += '<p>Addr: ' + patientInfo.addr + '</p>';
			document.getElementById("patientInfoDetail").innerHTML = patientInfoDetailHTML;
			document.getElementById("doctorInfo").style.display = "none";
			document.getElementById("patientInfo").style.display = "block";
		});
		socket.on('patientRecords', function(data){
			$("#patientRecords-table").find("tr:gt(0)").remove();
			console.log('patientRecords', data);
			var patientRecords = data.records;
			var buildRecordHTML = function(record) {
				var date = new Date(parseInt(record.RecordTime) * 1000);
				var y = date.getFullYear();
				var m = date.getMonth() + 1;
				var d = date.getDate();
				return '<tr><td>' + record.Hospital + '</td><td>' + record.Doctor
					+ '</td><td>' + y + '-' + m + '-' + d + '</td><td>' + record.Inspection
					+ '</td><td><button id="patientRecord-'+record.RecordId+'" data-rid="'
					+ record.RecordId + '" data-pid="' + data.id + '" data-th="'
					+ record.Hospital + '">Request Details</button></td>';
			};
			if(!patientRecords) return;
			for(var i = 0; i < patientRecords.length; i++) {
				var recordHTML = buildRecordHTML(patientRecords[i]);
				var row = document.getElementById("patientRecords-table").insertRow(1);
				row.innerHTML = recordHTML;
				$("#patientRecord-"+patientRecords[i].RecordId).click(function(){
					var rid = $(this).data('rid').toString();
					var pid = $(this).data('pid').toString();
					var targetHospital = $(this).data('th');
					console.log([rid, pid, targetHospital]);
					socket.emit('requestDetail', {rid: rid, did: globalDid, pid: pid,
											targetHospital: targetHospital});
				});
			}
		});
		socket.on('recordDetail', function(data){
			console.log('recordDetail', data);

			var detail = JSON.parse(data.recordDetail);
			console.log(detail);
			recordDetailHTML = '<p><fieldset><legend>Inspection</legend>'+detail.inspection+'</fieldset></p>';
			recordDetailHTML += '<p><fieldset><legend>Result</legend>'+detail.result+'</fieldset></p>';
			recordDetailHTML += '<p><fieldset><legend>Analysis</legend>'+detail.analysis+'</fieldset></p>';
			recordDetailHTML += '<p><fieldset><legend>Prescription</legend>'+detail.prescription+'</fieldset></p>';
			var files = detail.files;
			for(var i = 0; i < files.length; i++) {
				recordDetailHTML += '<p><img src="http://172.18.232.124:8080/file/'+files[i]+'" /></p>';
			}
			document.getElementById("recordDetail-div").innerHTML = recordDetailHTML;
			document.getElementById("recordDetail").style.display = "block";
			document.getElementById("patientRecords").style.display = "none";

		});
		socket.on('event', function(data){
			console.log(data);
			if(data.EventType === "deRegister") {
				var payload = JSON.parse(data.Payload);
				if(payload.Doctor === globalDid) {
					console.log("patient deRegister from me");
					var pid = payload.Patient;
					var row = document.getElementById("patientList-" + pid).parentElement.parentElement;
					console.log(row);
					document.getElementById("patientList-table").deleteRow(row.rowIndex);
				}
			}
			else if(data.EventType === "register") {
				var payload = JSON.parse(data.Payload);
				if(payload.Doctor === globalDid) {
					console.log("patient register to me", payload.Patient);
					var pid = payload.Patient;
					$.ajax({
						type: "GET",
						url: "/getPatientNameFromId/" + pid,
						success: function(text) {
							var patientHTML = buildPatientHTML({id: pid, name: text});
							console.log(patientHTML);
							var row = document.getElementById("patientList-table").insertRow(1);
							row.innerHTML = patientHTML;
							$('#patientList-' + pid).click(function(){
								var patientId = $(this).data('pid').toString();
								globalPid = patientId;
								console.log(globalPid);
								socket.emit('getPatientRecords', {patientId: patientId, doctorId: globalDid});
								document.getElementById("patientList").style.display = "none";
								document.getElementById("patientRecords").style.display = "block";
							});
						},
						error: function(xhr) {
						}
					});
				}
			}
			else if(data.EventType === "newRecord") {
				var payload = JSON.parse(data.Payload);
				if(payload.Doctor === globalDid && payload.Patient === globalPid) {
					console.log("patient has new record");
					socket.emit('getPatientRecords', {doctorId: globalDid, patientId: globalPid});
				}
			}
		});
	})

	 </script>
</html>
