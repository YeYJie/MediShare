<div id="patientList" style="display: block;">
	<h1 class="page-header">挂号病人</h1>
	<div class="row">
		<div style="height: 5vh;"></div>
	</div>
	<div class="row" id="patient-blocks"></div>
</div>

<script type="text/javascript">
	var myPatients = [];

	var buildPatientBlockHelper = function(patient) {
	return '<div class="col-md-3" id="patient-block-'+patient.id+'">'
		+  '  <div class="row">'
		+  '    <div class="col-md-6 col-md-offset-5">'
		+  '      <ul id="patientInfoHeader" class="nav nav-sidebar"><img src="/header/' + patient.id + '"></ul>'
		+  '    </div>'
		+  '  </div>'
		+  '  <div class="row">'
		+  '    <div class="col-md-6 col-md-offset-3">'
		+  '      <ul id="patientInfoContent" class="nav nav-sidebar">'
		+  '        <li><a>姓名: '+patient.name+'</a></li>'
		+  '        <li><button id="patientList-'+patient.id+'" data-pid="'+patient.id+'" class="btn btn-default btn-lg btn-block">检验</button></li>'
		+  '      </ul>'
		+  '    </div>'
		+  '  </div>'
		+  '</div>';
	};

	var buildPatientBlock = function(patient) {
		var index = myPatients.indexOf(patient.id);
		if (index > -1) return null;
		myPatients.push(patient.id);
		$.ajax({
			type: "GET",
			url: "/getPatientInfo/" + patient.id,
			success: function(text) {
				var patientHTML = buildPatientBlockHelper(text);
				if (!patientHTML) return;
				console.log(patientHTML);
				document.getElementById("patient-blocks").innerHTML += patientHTML;

				$('#patientList-' + patient.id.toString()).click(function() {
					var patientId = $(this).data('pid').toString();
					globalPid = patientId;
					socket.emit('getPatientRecords', {patientId: patientId, doctorId: globalDid});
					document.getElementById("patientList").style.display = "none";
					document.getElementById("diagnose").style.display = "block";
				});
			},
			error: function(xhr) {}
		});
	};

	$(function() {
		socket.on('patients', function(data) {
			console.log("[patients]", data);
			var patients = data.patients;

			for (var i = 0; i < patients.length; i++) {
				buildPatientBlock(patients[i]);
			}
		});
		socket.on('deRegister', function(data) {
			var pid = data.pid;
			var index = myPatients.indexOf(pid);
			if (index < 0) return;
			myPatients.splice(index, 1);
			$("#patient-block-" + pid).remove();
		});
	});
</script>
