<div id="diagnose">
	<div class="row">
		<div class="col-md-12">

			<ul class="nav nav-tabs" role="tablist" id="myTab">
				<li class="nav-item active"><a href="#xuechanggui-table" data-toggle="tab">血常规</a></li>
				<li class="nav-item"><a href="#gangongneng-table" data-toggle="tab">肝功能</a></li>
				<li class="nav-item"><a href="#liangduiban-table" data-toggle="tab">乙肝五项</a></li>
			</ul>

			<div class="tab-content">

				<div role="tabpanel" class="tab-pane fade in active" id="xuechanggui-table">
					<table class="table table-striped">
						<thead>
							<th nowrap>测试项目</th>
							<th nowrap>缩写</th>
							<th nowrap>结果</th>
							<th nowrap>单位</th>
							<th nowrap>提示</th>
							<th nowrap>参考范围</th>
						</thead>
						<tbody>
							<tr><td nowrap>谷草转氨酶</td><td>AST</td><td><input id="xuechanggui-AST" /></td><td>U/L</td><td>H</td><td>15~40</td></tr>
							<tr><td nowrap>谷丙转氨酶</td><td>ALT</td><td><input id="xuechanggui-ALT" /></td><td>U/L</td><td></td><td>3~35</td></tr>
							<tr><td nowrap>谷草/谷丙转氨酶比值</td><td>S/L</td><td><input id="xuechanggui-SL" /></td><td></td><td></td><td>0.91~2.25</td></tr>
							<tr><td nowrap>总蛋白</td><td>TPROT</td><td><input id="xuechanggui-TPROT" /></td><td>g/L</td><td></td><td>61.0~82.0</td></tr>
							<tr><td nowrap>白蛋白</td><td>ALB</td><td><input id="xuechanggui-ALB" /></td><td>g/L</td><td></td><td>36.0~51.0</td></tr>
							<tr><td nowrap>球蛋白</td><td>GLB</td><td><input id="xuechanggui-GLB" /></td><td>g/L</td><td></td><td>25.0~35.0</td></tr>
							<tr><td nowrap>白蛋白/球蛋白</td><td>A/G</td><td><input id="xuechanggui-AG" /></td><td></td><td></td><td>1.2~2.5</td></tr>
							<tr><td nowrap>总胆红素</td><td>TBILI</td><td><input id="xuechanggui-TBILI" /></td><td>umol/L</td><td></td><td>4.0~23.9</td></tr>
							<tr><td nowrap>直接胆红素</td><td>DBILI</td><td><input id="xuechanggui-DBILI" /></td><td>umol/L</td><td></td><td>0~6.8</td></tr>
							<tr><td nowrap>间接胆红素</td><td>IBILI</td><td><input id="xuechanggui-IBILI" /></td><td>umol/L</td><td></td><td>2.6~20.9</td></tr>
							<tr><td nowrap>谷氨酰转肽酶</td><td>GGT</td><td><input id="xuechanggui-GGT" /></td><td>U/L</td><td>H</td><td>10~60</td></tr>
							<tr><td nowrap>总胆汁酸</td><td>TBA</td><td><input id="xuechanggui-TBA" /></td><td>umol/L</td><td></td><td>0~14.0</td></tr>
							<tr><td nowrap>磷</td><td>IPHOS</td><td><input id="xuechanggui-IPHOS" /></td><td>umol/L</td><td></td><td>0.74~1.52</td></tr>
							<tr><td nowrap>尿素氮</td><td>BUN</td><td><input id="xuechanggui-BUN" /></td><td>umol/L</td><td></td><td>2.4~8.2</td></tr>
							<tr><td nowrap>肌酐(酶法)</td><td>CREAT</td><td><input id="xuechanggui-CREAT" /></td><td>umol/L</td><td></td><td>31.8~116.0</td></tr>
							<tr><td nowrap>磷酸肌酸激酶</td><td>CK</td><td><input id="xuechanggui-CK" /></td><td>U/L</td><td></td><td>24~184</td></tr>
							<tr><td><br/></td><td></td><td></td><td></td><td></td><td></td></tr>
							<tr><td nowrap>备注</td><td colspan="5"><textarea style="width: 100%;" id="xuechanggui-analysis" rows="3"></textarea></td></tr>
						</tbody>
					</table>
				</div>

				<div role="tabpanel" class="tab-pane fade" id="gangongneng-table">
					<table class="table table-striped">
						<thead>
							<th nowrap>测试项目</th>
							<th nowrap>缩写</th>
							<th nowrap>结果</th>
							<th nowrap>单位</th>
							<th nowrap>提示</th>
							<th nowrap>参考范围</th>
						</thead>
						<tbody>
							<tr><td nowrap>丙氨酸氨基转移酶</td><td>ALT</td><td><input id="gangongneng-ALT" /></td><td>U/L</td><td>阳性</td><td>0~40</td></tr>
							<tr><td nowrap>天门冬氨酸氨基转移酶</td><td>AST</td><td><input id="gangongneng-AST" /></td><td>U/L</td><td>阴性</td><td>0~40</td></tr>
							<tr><td nowrap>转氨酶比</td><td>AST:ALT</td><td><input id="gangongneng-AA" /></td><td></td><td></td><td>0.6~1.5</td></tr>
							<tr><td nowrap>总胆红素</td><td>TBIL</td><td><input id="gangongneng-TBIL" /></td><td>umol/L</td><td>阴性</td><td>1.71~17.1</td></tr>
							<tr><td nowrap>直接胆红素</td><td>DBIL</td><td><input id="gangongneng-DBIL" /></td><td>umol/L</td><td>阴性</td><td>0.51~3.24</td></tr>
							<tr><td nowrap>间接胆红素</td><td>IBIL</td><td><input id="gangongneng-IBIL" /></td><td>umol/L</td><td>阴性</td><td>1.71~13.8</td></tr>
							<tr><td nowrap>乙肝表面抗原</td><td>HBsAg</td><td><input id="gangongneng-HBsAg" /></td><td></td><td>阴性</td><td></td></tr>
							<tr><td nowrap>葡萄糖</td><td>GLU</td><td><input id="gangongneng-GLU" /></td><td>mmol/L</td><td></td><td>3.6~6.1</td></tr>
							<tr><td nowrap>球蛋白</td><td>GLO</td><td><input id="gangongneng-GLO" /></td><td>g/L</td><td></td><td>23~30</td></tr>
							<tr><td nowrap>白球比</td><td>A/G</td><td><input id="gangongneng-AG" /></td><td></td><td></td><td>1.5~2.5</td></tr>
							<tr><td nowrap>a-L-岩藻糖苷酶</td><td>AFU</td><td><input id="gangongneng-AFU" /></td><td>nKat/L</td><td></td><td>52~170</td></tr>
							<tr><td><br/></td><td></td><td></td><td></td><td></td><td></td></tr>
							<tr><td nowrap>备注</td><td colspan="5"><textarea style="width: 100%;" id="gangongneng-analysis" rows="3"></textarea></td></tr>
						</tbody>
					</table>
				</div>

				<div role="tabpanel" class="tab-pane fade" id="liangduiban-table">
					<table class="table table-striped">
						<thead>
							<th nowrap>测试项目</th>
							<th nowrap>缩写</th>
							<th nowrap>检验方法</th>
							<th nowrap>结果</th>
							<th nowrap>参考值</th>
						</thead>
						<tbody>
							<tr><td nowrap>乙肝表面抗原</td><td>HBsAg</td><td>酶免法</td><td><input id="liangduiban-HBsAg" /></td><td>阴性</td></tr>
							<tr><td nowrap>乙肝表面抗体</td><td>HBsAb</td><td>酶免法</td><td><input id="liangduiban-HBsAb" /></td><td>阴性</td></tr>
							<tr><td nowrap>乙肝e抗原</td><td>HBeAg</td><td>酶免法</td><td><input id="liangduiban-HBeAg" /></td><td>阴性</td></tr>
							<tr><td nowrap>乙肝e抗体</td><td>HBeAb</td><td>酶免法</td><td><input id="liangduiban-HBeAb" /></td><td>阴性</td></tr>
							<tr><td nowrap>乙肝核心抗体</td><td>HBcAb</td><td>酶免法</td><td><input id="liangduiban-HBcAb" /></td><td>阴性</td></tr>
							<tr><td><br/></td><td></td><td></td><td></td><td></td><td></td></tr>
							<tr><td nowrap>备注</td><td colspan="5"><textarea style="width: 100%;" id="liangduiban-analysis" rows="3"></textarea></td></tr>
						</tbody>
					</table>
				</div>

			</div>
		</div>
	</div>

	<div class="row">
		<div class="col-md-12">
			<div class="form-group">
				<label><h3>上传附件</h3></label>
				<div class="input-group">
					<span class="input-group-btn">
						<span class="btn btn-default btn-file">
							选择文件&hellip; <input type="file" id="attachmentFiles">
						</span>
					</span>
					<input type="text" class="form-control" readonly id="attachmentFilesName">
				</div>
				<img id='attachmentFilesPreview' class="img-responsive"/>
			</div>
		</div>
	</div>

	<div class="row">
		<div class="col-md-3 col-md-offset-9">
			<button id="diagnose-submit" class="btn btn-lg btn-primary btn-block" disabled>提交</button>
		</div>
	</div>
</div>


<script type="text/javascript">

	$(document).on('change', '.btn-file :file', function() {
		var input = $(this);
		var label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
		input.trigger('fileselect', [label]);
	});
	$('.btn-file :file').on('fileselect', function(event, label) {
		var input = $(this).parents('.input-group').find(':text');
		var log = label;
		if (input.length) {
			input.val(log);
		} else {
			if (log) alert(log);
		}

	});
	var readURL = function(input) {
		if (input.files && input.files[0]) {
			var reader = new FileReader();
			reader.onload = function(e) {
				$('#attachmentFilesPreview').attr('src', e.target.result);
			}
			reader.readAsDataURL(input.files[0]);
		}
	};
	$("#attachmentFiles").change(function() {
		readURL(this);
	});

	var inspection = "xuechanggui";

	var jianyanItems = {
		"xuechanggui": ["AST", "ALT", "SL", "TPROT", "ALB", "GLB", "AG", "TBILI", "DBILI", "IBILI", "GGT", "TBA", "IPHOS", "BUN", "CREAT", "CK"],
		"gangongneng": ["ALT", "AST", "AA", "TBIL", "DBIL", "IBIL", "HBsAg", "GLU", "GLO", "AG", "AFU"],
		"liangduiban": ["HBsAg", "HBsAb", "HBeAg", "HBeAb", "HBcAb"]
	};

	var gatherInputData = function() {
		var formData = new FormData();
		formData.append("pid", globalPid);
		formData.append("inspection", inspection);
		formData.append("analysis", $("#" + inspection + "-analysis").val());
		$.each($("#attachmentFiles")[0].files, function(i, file) {
			formData.append('attachmentFiles', file);
		});
		var items = jianyanItems[inspection];
		for(var i = 0; i < items.length; i++) {
			var inputId = inspection + "-" + items[i];
			formData.append(items[i], $("#" + inputId).val());
		}
		return formData;
	};

	var clearDiagnose = function() {
		for(var ins in jianyanItems) {
			var items = jianyanItems[ins];
			for(var i = 0; i < items.length; i++) {
				var inputId = ins + "-" + items[i];
				$("#" + inputId).val("");
			}
			$("#" + ins + "-analysis").val("");
		}
		document.getElementById("attachmentFiles").value = "";
		document.getElementById("attachmentFilesName").value = "";
		document.getElementById("attachmentFilesPreview").src = "";
	};

	$(function() {

		$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
			inspection = $(e.target).attr("href").slice(1, -6);
			// console.log(inspection);
		});

		$("#diagnose-submit").click(function() {
			var formData = gatherInputData();
			for (var pair of formData.entries()) {
				console.log(pair[0]+ ': ' + pair[1]);
			}

			$.ajax({
				type: "POST",
				url: "/jianyankeUpload",
				data: formData,
				contentType: false,
				processData: false,
				success: function(text) {
					console.log(text);
					return false;
				},
				error: function(xhr) {}
			});
			clearDiagnose();
		});

	});

</script>
