<div id="recordDetail" style="display: none;">
	<h3 class="page-header">记录详情</h3>
	<div id="recordDetail-content"></div>
</div>

<script type="text/javascript">
	var detailCache = {};
	var recordDetailTargetHospitalName = "";
	var recordDetailDoctorName = "";
	var recordDetailTime = "";

	// function clearDetail() {
	// 	document.getElementById("recordDetail-content").innerHTML = "";
	// }
	function hideDetail() {
		document.getElementById("recordDetail").style.display = "none";
	}

	var buildDetail = function(detail) {

		var buildDetailTableRow = function(name, value) {
			if(!value || value === "")
				value = "无";
			return '<tr><td class="col-md-3">' + name + ':</td><td colspan="3">' + value + '</td></tr>';
		};

		var buildDetailTable = function(detail) {
			var table = ''
				+'<table class="table table-bordered">'
				+'	<tbody>'
				+'		<tr>'
				+'			<td>就诊医院:</td><td colspan="3">' + recordDetailTargetHospitalName + '</td>'
				+'		</tr>'
				+'		<tr>'
				+'			<td>接诊医生:</td><td>' + recordDetailDoctorName + '</td>'
				+'			<td>时间:</td><td>' + recordDetailTime + '</td>'
				+'		</tr>';
			table += buildDetailTableRow("主诉", detail.zhusu);
			table += buildDetailTableRow("现病史", detail.xianbingshi);
			table += buildDetailTableRow("既往史", detail.jiwangshi);
			table += buildDetailTableRow("诊断", detail.zhenduan);
			table += buildDetailTableRow("治疗意见", detail.zhiliaoyijian);
			table += buildDetailTableRow("处方", detail.chufang);
			table += '	</tbody>'
					+'</table>';
			return table;
		};

		var buildAttachmentFile = function(attachmentFile) {
			return ''
			+'<div class="row">'
			+'	<div class="col-md-12">'
			+'		<div class="form-group">'
			+'			<img src="' + attachmentFile + '" class="img-responsive"/>'
			+'		</div>'
			+'	</div>'
			+'</div>';
		}

		var res = '';
		res += buildDetailTable(detail);

		if(detail.jianyan !== "undefined") {
			var inspections = JSON.parse(detail.jianyan);
			if(inspections) {
				inspections.forEach(function(ins){
					res += buildInspection(ins);
				});
			}
		}

		var attachmentFiles = detail.attachmentFiles;
		console.log("[buildDetail] attachmentFiles: ", attachmentFiles);
		if(attachmentFiles.length > 0) {
			attachmentFiles.forEach(function(af){
				res += buildAttachmentFile(af);
			});
		}

		return res;
	};


	var updateDetailCache = function(pid, targetHospital, rid, detail) {
		var cacheIndex = pid + targetHospital.toString() + rid;
		detailCache[cacheIndex] = detail;
		console.log("updateDetailCache ", detailCache);
	}

	var requestDetail = function(pid, targetHospital, rid) {
		var requestArgs = {rid: rid, did: globalDid, pid: pid, targetHospital: targetHospital};
		console.log("requestDetail args: ", requestArgs);
		socket.emit('requestDetail', requestArgs);
	}

	socket.on('recordDetail', function(data){
		console.log('recordDetail data: ', data);
		var detail = JSON.parse(data.recordDetail);
		updateDetailCache(data.pid, data.targetHospital, data.rid, detail);
		showRecordDetail(data.pid, data.targetHospital, data.rid);
	});

	var showRecordDetail = function(pid, targetHospital, rid) {
		var cacheIndex = pid + targetHospital.toString() + rid;
		var detail = detailCache[cacheIndex];
		// console.log("showRecordDetail detail:", detail);
		if(detail) {
			// console.log("showRecordDetail cache hit: ", cacheIndex);
			document.getElementById("recordDetail-content").innerHTML = buildDetail(detail);
			document.getElementById("recordDetail").style.display = "block";
		} else {
			// console.log("showRecordDetail cache miss: ", cacheIndex);
			requestDetail(pid, targetHospital, rid);
		}
	};

	$(function(){
	});

</script>
