<div id="patientList">
	<h3 class="page-header">挂号患者</h3>
	<div class="row" id="patient-blocks">
		<div class="col-md-12">
			<ul class="nav nav-pills nav-stacked" id="patientList-ul"></ul>
		</div>
	</div>
</div>

<script type="text/javascript">
	var myPatients = [];
	var currentPatient = {};

	var buildPatientBlockHelper = function(patient) {
		return '<li><a href="#" data-toggle="tab"'
				+' data-pid="' + patient.pid + '"'
				+' data-pname="' + patient.pname + '"'
				+' data-did="' + patient.did + '"'
				+' data-dname="' + patient.dname + '"'
				+' data-keshi="' + patient.keshi + '"'
				+' id="patientList-'+patient.pid+'">' + patient.pname + '</a></li>';
	};

	var addPatient = function(patient) {
		console.log("[addPatient]: ", patient);

		$("#patientList-ul").append(buildPatientBlockHelper(patient));

		$('#patientList-' + patient.pid).click(function(){
			clearDiagnose();
			hideDetail();

			var pid = $(this).data('pid').toString();
			globalPid = pid;

			currentPatient.pid = $(this).data('pid').toString();
			currentPatient.pname = $(this).data('pname');
			currentPatient.did = $(this).data('did').toString();
			currentPatient.dname = $(this).data('dname');
			currentPatient.keshi = $(this).data('keshi');
			console.log("patientList currentPatient: ", currentPatient);

			document.getElementById("diagnose-submit").disabled = false;
			showPatientInfo(pid);
			showPatientRecords(pid);
		});
	}


	function processPatients(patients) {
		console.log("[processPatients]: ", patients);
		for(var i = 0; i < patients.length; i++) {
			var index = myPatients.indexOf(patients[i].pid);
			if(index > -1) {
				console.log("patientList.html processPatients patient exists: " + patients[i].pid);
				continue;
			}
			myPatients.push(patients[i].pid);
			addPatient(patients[i]);
		}
		console.log("[processPatients]myPatients: ", myPatients);
	}

	function getDoctorPatients(did) {
		$.ajax({
			type: "GET",
			url: "/getDoctorsPatients/" + did,
			success: function(doctorPatients) {
				console.log("[patientList.html getDoctorsPatients]: ", doctorPatients);
				processPatients(doctorPatients.patients);
				return false;
			},
			error: function(xhr) {
				console.log("[patientList.html getDoctorsPatients]err: ", xhr);
			}
		});
	}

	function patientDeRegister(pid) {
		var index = myPatients.indexOf(pid);
		if (index > -1)
			myPatients.splice(index, 1);
		$("#patientList-" + pid).parent().remove();
		if(globalPid === pid) {
			clearPatientInfo();
			clearPatientRecords();
			removeCacheForPatient(pid);
			hideDetail();
		}
	}

	$(function() {

		socket.on('patients', function(data) {
			console.log("patientList.html socket.on patients data: ", data);
			var patients = data.patients;
			processPatients(patients);
		});

	});
</script>
