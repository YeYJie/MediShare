<div id="patientList">
	<h3 class="page-header">挂号病人</h3>
	<div class="row" id="patient-blocks">
		<div class="col-md-12">
			<ul class="nav nav-pills nav-stacked" id="patientList-ul"></ul>
		</div>
	</div>
</div>

<script type="text/javascript">
	var myPatients = [];
	var currentPatient = {};

	var buildPatientBlockHelper = function(patient) {
		return '<li><a href="#" data-toggle="tab"'
				+' data-pid="' + patient.pid + '"'
				+' data-pname="' + patient.pname + '"'
				+' data-did="' + patient.did + '"'
				+' data-dname="' + patient.dname + '"'
				+' data-keshi="' + patient.keshi + '"'
				+' id="patientList-'+patient.pid+'">' + patient.pname + '</a></li>';
	};

	var addPatient = function(patient) {
		console.log("[addPatient]: ", patient);
		var index = myPatients.indexOf(patient.pid);
		if(index > -1) return null;
		myPatients.push(patient.pid);

		document.getElementById("patientList-ul").innerHTML += buildPatientBlockHelper(patient);

		$('#patientList-' + patient.pid.toString()).click(function(){
			clearDiagnose();

			var patientId = $(this).data('pid').toString();
			globalPid = patientId;

			currentPatient.pid = $(this).data('pid').toString();
			currentPatient.pname = $(this).data('pname');
			currentPatient.did = $(this).data('did').toString();
			currentPatient.dname = $(this).data('dname');
			currentPatient.keshi = $(this).data('keshi');
			console.log("patientList currentPatient: ", currentPatient);

			socket.emit('getPatientRecords', {pid: patientId, did: globalDid});

			document.getElementById("diagnose-submit").disabled = false;
			if(document.getElementById("recordDetail")) {
				document.getElementById("recordDetail").style.display = "none";
			}
		});
	}

	function processPatients(patients) {
		console.log("[processPatients]: ", patients);
		for(var i = 0; i < patients.length; i++) {
			addPatient(patients[i]);
		}
	}

	function patientDeRegister(pid) {
		var index = myPatients.indexOf(pid);
		if (index > -1)
			myPatients.splice(index, 1);
		$("#patientList-" + pid).parent().remove();
				// $("#patient-block-" + pid).remove();
		if(globalPid === pid) {
			clearPatientInfo();
			clearPatientRecords();
		}
	}

	$(function() {

		socket.on('patients', function(data) {
			console.log("socket.on patients data: ", data);
			var patients = data.patients;
			processPatients(patients);
		});

	});
</script>
